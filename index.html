<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container">
    <ul class="comments">
      <div class="loading-message-top" style="display: none;">Пожалуйста подождите, загружаю комментарии...</div>
      <!-- Спиосок рендерится из JS -->
    </ul>
    <div class="add-form">
      <input type="text" class="add-form-name" placeholder="Введите ваше имя" />
      <textarea type="textarea" class="add-form-text" placeholder="Введите ваш комментарий" rows="4"></textarea>
      <div class="add-form-row">
        <button class="add-form-button">Написать</button>
      </div>
    </div>
    <div class="loading-message-bottom" style="display: none;">Комментарий добавляется...</div>
  </div>

  <script>
    "use strict";

    // Код писать здесь
    let comments = [];

    const fetchComments = () => {
      // Show loading message when fetching comments begins
      const loadingMessageTop = document.querySelector('.loading-message-top');
      loadingMessageTop.style.display = 'block';

      fetch('https://wedev-api.sky.pro/api/v1/adam-batukaev/comments', {
        method: "GET"
      })
        .then((response) => {
          return response.json();
        })
        .then((responseData) => {
          comments = responseData.comments;
          renderComments();
        })
        .then(() => {
          // Hide loading message when comments are rendered 
          loadingMessageTop.style.display = 'none';
        });
    };

    const generateHtml = (comments) => {
      const commentsListHtml = comments.map((comment, index) => {
        const likeButtonClass = comment.isLiked ? 'like-button liked' : 'like-button';
        const formattedDate = new Date(comment.date).toLocaleString('ru-RU', {
          day: 'numeric',
          month: 'numeric',
          year: 'numeric',
          hour: 'numeric',
          minute: 'numeric',
        });
        return `
        <li class="comment">      
          <div class="comment-header">        
            <div class="commentator-name" data-name='${comment.author.name}'>${comment.author.name}</div>
            <div>${formattedDate}</div>
          </div>
          <div class="comment-body">
            <div class="comment-text" data-text="${comment.text}">${comment.text}</div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">${comment.likes}</span>
              <button class="${likeButtonClass}" data-index="${index}"></button>
            </div>
          </div>
        </li>`;
      }).join('');
      return commentsListHtml;
    };

    const renderComments = () => {
      const commentsList = document.querySelector('.comments');
      commentsList.innerHTML = generateHtml(comments);

      const commentElements = document.querySelectorAll('.comment');

      for (const commentElement of commentElements) {
        const commentTextElement = commentElement.querySelector('.comment-text');
        const commentatorNameElement = commentElement.querySelector('.commentator-name');

        commentElement.addEventListener('click', () => {
          const comment = commentTextElement.dataset.text;
          const name = commentatorNameElement.dataset.name;

          document.querySelector('.add-form-text').value = `${comment}\n> ${name}`;
        });
      }

      putLike();
    };

    const putLike = () => {
      const likeButtonElements = document.querySelectorAll('.like-button');

      for (const likeButtonElement of likeButtonElements) {
        likeButtonElement.addEventListener('click', (event) => {
          event.stopPropagation();
          const index = likeButtonElement.dataset.index;

          if (comments[index].isLiked) {
            comments[index].isLiked = false;
            comments[index].likes--;
          } else {
            comments[index].isLiked = true;
            comments[index].likes++;
          }
          renderComments();
        });
      }
    };


    const addComment = () => {
      const name = document.querySelector('.add-form-name').value;
      const comment = document.querySelector('.add-form-text').value;

      if (name === '' || comment === '') {
        return; // Validation failed, do not add the comment
      }

      // Show loading message when adding comment begins
      const loadingMessageBottom = document.querySelector('.loading-message-bottom');
      loadingMessageBottom.style.display = 'block';

      const addCommentElement = document.querySelector('.add-form');
      addCommentElement.style.display = 'none';

      const newComment = {
        text: comment.replaceAll('<', '&lt;').replaceAll('>', '&gt;'),
        name: name.replaceAll('<', '&lt;').replaceAll('>', '&gt;')
      };

      // POST the new comment to the server
      fetch('https://wedev-api.sky.pro/api/v1/adam-batukaev/comments', {
        method: "POST",
        body: JSON.stringify(newComment),
      })
        .then((response) => {
          return response.json();
        })
        .then((responseData) => {
          return fetch('https://wedev-api.sky.pro/api/v1/adam-batukaev/comments', {
            method: "GET",
          });
        })
        .then((response) => {
          return response.json();
        })
        .then((responseData) => {
          comments = responseData.comments;
          renderComments();
        })
        .then(() => {
          // Hide loading message when comments are rendered 
          loadingMessageBottom.style.display = 'none';
          addCommentElement.style.display = 'flex';
        });


      // Clear input
      document.querySelector('.add-form-name').value = '';
      document.querySelector('.add-form-text').value = '';
    };

    const addButton = document.querySelector('.add-form-button');
    addButton.addEventListener('click', addComment);

    // Fetch initial comments from the server
    fetchComments();

  </script>

</html>